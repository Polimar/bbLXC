generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  username      String    @unique
  isAdmin       Boolean   @default(false)
  accountType   AccountType @default(FREE)
  premiumExpiresAt DateTime?
  isOnline      Boolean   @default(false)
  lastSeen      DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  games         GamePlayer[]
  refreshTokens RefreshToken[]
  ownedQuestionSets QuestionSet[] @relation("QuestionSetOwner")
  
  // Avatar system
  selectedAvatarId String?
  selectedAvatar   Avatar? @relation("SelectedAvatar", fields: [selectedAvatarId], references: [id])
  ownedAvatars     UserAvatar[]
  avatarCustomizations AvatarCustomization[]
  
  // Friendship relations
  sentFriendRequests     FriendRequest[] @relation("SentRequests")
  receivedFriendRequests FriendRequest[] @relation("ReceivedRequests")
  friendships1           Friendship[]    @relation("User1Friendships")
  friendships2           Friendship[]    @relation("User2Friendships")
  
  // LLM Configuration
  llmConfigs    LLMConfig[]
  
  // Ads tracking
  adImpressions AdImpression[]
  
  // In-app purchases
  purchases     Purchase[]
  cart          CartItem[]
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model QuestionSet {
  id          String     @id @default(cuid())
  name        String
  description String?
  category    String
  difficulty  Difficulty
  isPublic    Boolean    @default(true)
  isPremium   Boolean    @default(false)
  ownerId     String?    // null for system question sets
  questions   Question[]
  games       Game[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  owner User? @relation("QuestionSetOwner", fields: [ownerId], references: [id])
}

model Question {
  id            String      @id @default(cuid())
  questionSetId String
  questionSet   QuestionSet @relation(fields: [questionSetId], references: [id])
  text          String
  options       Json        // Array of {id, text}
  correctAnswer String
  timeLimit     Int         @default(30)
  points        Int         @default(100)
  order         Int
}

model Game {
  id             String       @id @default(cuid())
  code           String       @unique
  questionSetId  String
  questionSet    QuestionSet  @relation(fields: [questionSetId], references: [id])
  status         GameStatus   @default(WAITING)
  maxPlayers     Int          @default(8)
  currentRound   Int          @default(0)
  totalRounds    Int          @default(10)
  timePerQuestion Int         @default(30)
  isPrivate      Boolean      @default(false)
  inviteCode     String?      @unique
  players        GamePlayer[]
  createdAt      DateTime     @default(now())
  startedAt      DateTime?
  endedAt        DateTime?
}

model GamePlayer {
  id        String   @id @default(cuid())
  gameId    String
  game      Game     @relation(fields: [gameId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  score     Int      @default(0)
  isLeader  Boolean  @default(false)
  joinedAt  DateTime @default(now())
  
  @@unique([gameId, userId])
}

model FriendRequest {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  status     FriendRequestStatus @default(PENDING)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  sender     User @relation("SentRequests", fields: [senderId], references: [id])
  receiver   User @relation("ReceivedRequests", fields: [receiverId], references: [id])
  
  @@unique([senderId, receiverId])
}

model Friendship {
  id        String   @id @default(cuid())
  user1Id   String
  user2Id   String
  createdAt DateTime @default(now())
  
  user1 User @relation("User1Friendships", fields: [user1Id], references: [id])
  user2 User @relation("User2Friendships", fields: [user2Id], references: [id])
  
  @@unique([user1Id, user2Id])
}

model LLMConfig {
  id       String @id @default(cuid())
  userId   String
  provider LLMProvider
  apiKey   String // Encrypted
  endpoint String?
  model    String?
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id])
  
  @@unique([userId, provider])
}

model AdImpression {
  id        String   @id @default(cuid())
  userId    String
  adType    AdType
  adUnit    String
  clicked   Boolean  @default(false)
  revenue   Decimal? @db.Decimal(10,4)
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id])
}

model Avatar {
  id          String @id @default(cuid())
  name        String
  description String?
  category    AvatarCategory
  imageUrl    String
  animationUrl String?
  isPremium   Boolean @default(false)
  price       Decimal? @db.Decimal(10,2)
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)
  createdAt   DateTime @default(now())
  
  // Relations
  selectedByUsers User[] @relation("SelectedAvatar")
  ownedByUsers    UserAvatar[]
  customizations  AvatarCustomization[]
  shopItems       ShopItem[]
}

model UserAvatar {
  id        String   @id @default(cuid())
  userId    String
  avatarId  String
  unlockedAt DateTime @default(now())
  purchaseId String?
  
  user     User     @relation(fields: [userId], references: [id])
  avatar   Avatar   @relation(fields: [avatarId], references: [id])
  purchase Purchase? @relation(fields: [purchaseId], references: [id])
  
  @@unique([userId, avatarId])
}

model AvatarCustomization {
  id        String @id @default(cuid())
  userId    String
  avatarId  String
  colorScheme Json // {primary: "#FF6943", secondary: "#FFD700"}
  accessories Json // ["hat", "glasses", "bowtie"]
  animation   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user   User   @relation(fields: [userId], references: [id])
  avatar Avatar @relation(fields: [avatarId], references: [id])
  
  @@unique([userId, avatarId])
}

model ShopItem {
  id          String @id @default(cuid())
  name        String
  description String
  category    ShopCategory
  itemType    ShopItemType
  price       Decimal @db.Decimal(10,2)
  originalPrice Decimal? @db.Decimal(10,2)
  currency    String @default("EUR")
  
  // Product data
  avatarId    String?
  avatar      Avatar? @relation(fields: [avatarId], references: [id])
  bundleItems Json? // For bundle products
  metadata    Json? // Additional product data
  
  // Availability
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  availableFrom DateTime?
  availableUntil DateTime?
  maxPurchases Int? // Limit per user
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  purchases   Purchase[]
  cartItems   CartItem[]
}

model Purchase {
  id            String @id @default(cuid())
  userId        String
  shopItemId    String
  transactionId String @unique // From payment provider
  platform      PurchasePlatform
  status        PurchaseStatus @default(PENDING)
  amount        Decimal @db.Decimal(10,2)
  currency      String
  paymentMethod String?
  
  // Validation
  receipt       Json? // Store receipt data
  verified      Boolean @default(false)
  verifiedAt    DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User @relation(fields: [userId], references: [id])
  shopItem      ShopItem @relation(fields: [shopItemId], references: [id])
  userAvatars   UserAvatar[]
}

model CartItem {
  id         String @id @default(cuid())
  userId     String
  shopItemId String
  quantity   Int @default(1)
  addedAt    DateTime @default(now())
  
  user     User     @relation(fields: [userId], references: [id])
  shopItem ShopItem @relation(fields: [shopItemId], references: [id])
  
  @@unique([userId, shopItemId])
}

enum AccountType {
  FREE
  PREMIUM
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum GameStatus {
  WAITING
  IN_PROGRESS
  FINISHED
  CANCELLED
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum LLMProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  CUSTOM
}

enum AdType {
  BANNER
  INTERSTITIAL
  REWARDED
}

enum AvatarCategory {
  ANIMALS
  FANTASY
  PROFESSIONALS
  SCIFI
  SEASONAL
  EXCLUSIVE
}

enum ShopCategory {
  AVATARS
  CUSTOMIZATION
  QUESTION_SETS
  POWER_UPS
  SUBSCRIPTIONS
  BUNDLES
}

enum ShopItemType {
  AVATAR
  COLOR_PACK
  ACCESSORY_PACK
  ANIMATION_PACK
  QUESTION_SET
  POWER_UP
  SUBSCRIPTION
  BUNDLE
}

enum PurchasePlatform {
  GOOGLE_PLAY
  APP_STORE
  WEB_STRIPE
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}
